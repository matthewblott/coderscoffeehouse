I"x"<p>I’ve been following F# for a while but it’s only recently started appearing in my workflow for serious work. I’m not a good F# programmer at all but I’m confident enough to use it in small scripts and I think it does a pretty good job here. However, I recently discovered the front end testing framework <a href="http://lefthandedgoat.github.io/canopy/">Canopy</a> and this provides an excellent opening for anyone looking for a low level entry to the F# world.</p>

<p>In the past when I’ve bothered to test the front end in a .NET project I’ve used <a href="http://fluent.stirno.com/">FluentAutomation</a>. It’s essentially a wrapper for Selenium - the same as Canopy and nearly all the front end testing frameworks - but it hasn’t been updated in a long time and I always found coding in C# to test front end incredibly verbose. This is where Canopy shines, it has a really easy to use DSL that works using the query selectors anyone who’s done any front end work will be familiar with.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="s2">"#welcome"</span> <span class="o">==</span> <span class="s2">"Welcome"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>I won’t go into detail as the Canopy site has some good introduction videos which contain enough to get you going but the snippet above gives you an idea of how simple it is.</p>

<p>The reason for this post is because I soon hit a problem when I wanted to automate my tests. I needed them to be headless but I was having <a href="https://github.com/lefthandedgoat/canopy/issues/320">problems</a> with the PhantomJS driver. If you follow the thread in the link you’ll see I tried some workarounds but it seems like the issue is PhantomJS rather than Canopy. So it was suggested I should try running Chrome in headless mode which is what we’re going to do here.</p>

<p>The first thing you’ll need to do is setup your Linux server and install Mono. I’ve already written a brief tutorial on that <a href="/tech/2015/12/09/mono-linux-setup.html">here</a>. I suggest following the instructions on the Mono site (which I’ve documented) and not just following what it says on the main F# site as there are some steps missing.</p>

<p>Once that’s done you’ll need to install F# and nuget.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>fsharp
<span class="nb">sudo </span>apt-get <span class="nb">install </span>nuget
</pre></td></tr></tbody></table></code></pre></figure>

<p>Then install unzip.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>unzip
</pre></td></tr></tbody></table></code></pre></figure>

<p>Download the Chrome driver and unzip the contents (note that this file needs to be in the root of your project).</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>wget https://chromedriver.storage.googleapis.com/2.26/chromedriver_linux64.zip
unzip chromedriver_linux64.zip
</pre></td></tr></tbody></table></code></pre></figure>

<p>Install Chrome.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre>wget <span class="nt">-q</span> <span class="nt">-O</span> - https://dl-ssl.google.com/linux/linux_signing_key.pub | <span class="nb">sudo </span>apt-key add -
<span class="nb">sudo </span>sh <span class="nt">-c</span> <span class="s1">'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" &gt;&gt; /etc/apt/sources.list.d/google.list'</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>google-chrome-stable
</pre></td></tr></tbody></table></code></pre></figure>

<p>The final install is the <code class="language-plaintext highlighter-rouge">xvfb</code> package (<a href="https://en.wikipedia.org/wiki/Xvfb">X virtual framebuffer</a>) which makes the magic happen (a big thanks goes to Chris Holt the Canopy author who gave me the information that this tutorial is based on).</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>xvfb
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now with everything in place we can setup a test. First install the required <code class="language-plaintext highlighter-rouge">nuget</code> packages.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>nuget <span class="nb">install </span>canopy <span class="nt">-excludeVersion</span> <span class="nt">-outputdirectory</span> packages
<span class="nb">rm</span> <span class="nt">-r</span> packages/Selenium.WebDriver
nuget <span class="nb">install </span>selenium.webdriver <span class="nt">-excludeVersion</span> <span class="nt">-version</span> 3.0.0 <span class="nt">-outputdirectory</span> packages
</pre></td></tr></tbody></table></code></pre></figure>

<p>You’ll notice in the second line above the <code class="language-plaintext highlighter-rouge">Selenium.WebDriver</code> package is removed. This is because there is an issue with version 3.0.1 (the latest at the time of writing) and version 3.0.0 is required in order for Canopy to work (this is the version used with the CanopyStarterKit).</p>

<p>Then create a simple test file. The file will simply check the <code class="language-plaintext highlighter-rouge">h1</code> tag displays the correct text on the home page and about page of this website.</p>

<p>First create the file.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>vi canopy.fsx
</pre></td></tr></tbody></table></code></pre></figure>

<p>Then paste the contents below into the file and save with <code class="language-plaintext highlighter-rouge">!wq</code>.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="c">#r "./packages/Selenium.WebDriver/lib/net40/WebDriver.dll"</span>
<span class="c">#r "./packages/canopy/lib/canopy.dll"</span>

open canopy
open runner

canopy.configuration.chromeDir &lt;- <span class="s2">"."</span>

start chrome

<span class="s2">"Should check home page h1"</span> <span class="o">&amp;&amp;</span>&amp; fun _ -&gt;
  url <span class="s2">"http://coderscoffeehouse.com/"</span>

  <span class="s2">"h1"</span> <span class="o">==</span> <span class="s2">"Coder's Coffee House"</span>

<span class="s2">"Should check about page h1"</span> <span class="o">&amp;&amp;</span>&amp; fun _ -&gt;
  url <span class="s2">"http://coderscoffeehouse.com/about"</span>

  <span class="s2">"h1"</span> <span class="o">==</span> <span class="s2">"About"</span>

run<span class="o">()</span>

quit<span class="o">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>I was then able to run the following.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nv">DISPLAY</span><span class="o">=</span>:1 xvfb-run fsharpi canopy.fsx
</pre></td></tr></tbody></table></code></pre></figure>

<p>And the result was the following.</p>

<p><img src="/assets/posts/20170117/011012-sm-b0f2eeec444b4b2b4c825489db281fb0.jpg" alt="" /></p>

<p>This is a pretty rudimentary example but it’s all the information you need if you want to include headless testing in your CI build. Any comments please leave below, thanks :-)</p>
:ET