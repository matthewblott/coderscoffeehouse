I"ú$<p>So, you‚Äôve got an old ASP.NET website using the now (or so it seems) disliked Web Forms that really needs upgrading but you simply don‚Äôt  have the time or resources to devote to the task. But making incremental changes with all the good new stuff is difficult because websites don‚Äôt play as well with the VS tools like web projects do. Some problems:</p>

<ul>
  <li>
    <p>I am forced to convert a website to a web project - a bit of a task in itself as there is no natural converion method or tools to do this.</p>
  </li>
  <li>
    <p>My old site is problem enough so I want to be able to upload an .aspx page without having to build the whole site everytime I want to make a change - ASP.NET websites allow me to do this, projects do not. I also don‚Äôt want to use a web project because I end up with all this in my file system.</p>
  </li>
</ul>

<p><img src="/images/2014-11-26/solution-explorer.jpg" alt="" /></p>

<p>The bloated solution VS creates that I have to pick through and then remove the bits I don‚Äôt want (shouldn‚Äôt it be the other way round?).</p>

<p>I just want to add the odd controller and build from there. And although it‚Äôs not obvious it can be done.</p>

<p>Add the correct libraries. This took some effort as MVC uses a lot of extension methods so it isn‚Äôt always apparent that the correct library is loaded. Also, the namespaces can be confusing - Microsoft.AspNet.Mvc and System.Web.Mvc both appear to be the same upon inspection. The files below are the only ones you will need.</p>

<p><img src="/images/2014-11-26/required-libraries.jpg" alt="" /></p>

<p>Add the correct handlers and assemblies to web.config. Needless to say when you install stuff via VS or Nuget you get a lot of unncessary boiler plate additions you can live without. Here is a barebones example of what you need in web.config.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0"?&gt;</span>
  <span class="nt">&lt;system.web&gt;</span>
    <span class="nt">&lt;compilation</span> <span class="na">targetFramework=</span><span class="s">"4.5"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;assemblies&gt;</span>
        <span class="nt">&lt;add</span> <span class="na">assembly=</span><span class="s">"System.Net.Http, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B03F5F7F11D50A3A"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;add</span> <span class="na">assembly=</span><span class="s">"System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/assemblies&gt;</span>
    <span class="nt">&lt;/compilation&gt;</span>
  <span class="nt">&lt;/system.web&gt;</span>
  <span class="nt">&lt;runtime&gt;</span>
    <span class="nt">&lt;assemblyBinding</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:asm.v1"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;dependentAssembly&gt;</span>
        <span class="nt">&lt;assemblyIdentity</span> <span class="na">name=</span><span class="s">"Newtonsoft.Json"</span>
          <span class="na">publicKeyToken=</span><span class="s">"30ad4fe6b2a6aeed"</span> <span class="na">culture=</span><span class="s">"neutral"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;bindingRedirect</span> <span class="na">oldVersion=</span><span class="s">"0.0.0.0-6.0.0.0"</span> <span class="na">newVersion=</span><span class="s">"6.0.0.0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/dependentAssembly&gt;</span>
    <span class="nt">&lt;/assemblyBinding&gt;</span>
  <span class="nt">&lt;/runtime&gt;</span>
  <span class="nt">&lt;system.webServer&gt;</span>
    <span class="nt">&lt;handlers&gt;</span>
      <span class="nt">&lt;remove</span> <span class="na">name=</span><span class="s">"ExtensionlessUrlHandler-Integrated-4.0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;remove</span> <span class="na">name=</span><span class="s">"OPTIONSVerbHandler"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;remove</span> <span class="na">name=</span><span class="s">"TRACEVerbHandler"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"ExtensionlessUrlHandler-Integrated-4.0"</span> <span class="na">path=</span><span class="s">"*."</span>
        <span class="na">verb=</span><span class="s">"*"</span><span class="na">type=</span><span class="s">"System.Web.Handlers.TransferRequestHandler"</span>
        <span class="na">preCondition=</span><span class="s">"integratedMode,runtimeVersionv4.0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/handlers&gt;</span>
  <span class="nt">&lt;/system.webServer&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Add the routes you want to use with your application. This one through me as the MapHttpRoute method is an extension method and it doesn‚Äôt appear with code completion even after the site is built. The code is executed at the start so I have placed it in the Global.asax code behind.</p>

<figure class="highlight"><pre><code class="language-aspx-vb" data-lang="aspx-vb"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre>Imports System.Web.Http
Imports System.Web.Routing

Public Class AppStart
  Inherits HttpApplication

  Protected Sub Application_Start(sender As Object, e As EventArgs)

    RouteTable.Routes.MapHttpRoute("webApi", "api/{controller}/{action}", _
      New With {.action = RouteParameter.Optional})
      
  End Sub

End Class
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now we have a router in place we can start adding some controls. For this example I‚Äôve just added a simple web user control that mimics a login control.</p>

<figure class="highlight"><pre><code class="language-aspx-vb" data-lang="aspx-vb"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre>&lt;%@ Control %&gt;

&lt;form method="post" action="api/login"&gt;
  &lt;input placeholder="Username" name="name" required /&gt;
  &lt;input type="password" placeholder="Password" name="password" required /&gt;
  &lt;input type="submit" value="Login" /&gt;
&lt;/form&gt;
</pre></td></tr></tbody></table></code></pre></figure>

<p>The control is placed in master page in this example.</p>

<figure class="highlight"><pre><code class="language-aspx-vb" data-lang="aspx-vb"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre>&lt;%@ Master %&gt;
&lt;%@ Register Src="Login.ascx" TagName="Login" TagPrefix="uc1" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;ASP.NET Website with Web Api&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;uc1:Login runat="server" /&gt;
    &lt;form runat="server"&gt;
      &lt;asp:ContentPlaceHolder ID="content" runat="server" /&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre></td></tr></tbody></table></code></pre></figure>

<p>Finally to wrap it all up a controller is added to manage the http requests. For this example I created the POCO ‚ÄúUser‚Äù object which is sent via a post request. Because Web API automatically maps the request type to the controller you can simply call the method ‚ÄúPost‚Äù.</p>

<figure class="highlight"><pre><code class="language-vbnet" data-lang="vbnet"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre>Imports System.Web.Http

Public Class LoginController
  Inherits ApiController
  
  Public Sub Post(&lt;FromBody()&gt; user As User)

    Dim name = "login-error"
  
    If user.Name = "matt" And user.Password = "password" Then
      name = "welcome"
    End
    
    HttpContext.Current.Response.Redirect(String.Format("/{0}.html", name))

  End Sub

End Class
</pre></td></tr></tbody></table></code></pre></figure>

<p>So now when we navigate to an aspx page and enter the details in the login form we have Web API working alongside Web Forms.</p>

<p><img src="/images/2014-11-26/login-form.jpg" alt="" /></p>

<p>And we can debug just as we would if we were using a VS Web Project rather than a more simple website.</p>

<p><img src="/images/2014-11-26/debugging.jpg" alt="" /></p>

<p>This is a really basic example and is missing a few things (session state for example) and I usually code in C# but copied this code from a website I currently support. It is possible to have both C# and VB.NET running side by side (another reason I didn‚Äôt want to convert the website to a project) but that‚Äôs a post for another day.</p>

<p>Please add comments below and let me know if you found this useuful.</p>

<p>All the code for this post can be found on github <a href="https://github.com/matthewblott/WebsiteWithApi">here</a>.</p>
:ET